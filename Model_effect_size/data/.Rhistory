ggplot(df, aes(x=total_cost/total_length, group=cost2,fill=cost2))+geom_density(alpha=.2)
ggplot(df, aes(x=sinuosity, group=cost2,fill=cost2))+geom_density(alpha=.2)
d<-rgamma(10000, 3,.01)
hist(d)
#A gamma distribution is most appropriate.
m <- brm(
formula = rat ~ cost2 * target_closed_fraction + (1 + cost2 | replicate),
data = df,
family = Gamma(link=log),
cores = 4,
chains = 4,
seed = 123,
control = list(adapt_delta = 0.99, max_treedepth = 12),
backend = "cmdstanr"
)
summary(m)
saveRDS(m, "gamma_m_nov.RDS")
m <- readRDS("gamma_m_nov.RDS")
setwd(paste(here::here(),"/Model_effect_size/model", sep="",collapse=""))
saveRDS(m, "gamma_m_nov.RDS")
m <- readRDS("gamma_m_nov.RDS")
library(ggplot2)
library(brms)
library(bayesplot)
library(tidybayes)
library(dplyr)
setwd(paste(here::here(),"/Model_effect_size/model", sep="",collapse=""))
m <- readRDS("gamma_m_nov.RDS")
setwd(paste(here::here(),"/Model_effect_size/data", sep="",collapse=""))
df<-read.csv("2025_11_18_11targ0.6_cl_size5_r_size5targ0.7_cl_size5_r_size5targ0.8_cl_size5_r_size5targ0.9_cl_size5_r_size5.csv")
setwd(paste(here::here(),"/Model_effect_size/figs", sep="",collapse=""))
df$rat<-df$total_cost/df$total_length
df<-df[which(df$total_length>0),]
df
hist(df$rat)
# Create prediction data for plotting
pred_data <- expand.grid(
cost2 = seq(min(df$cost2), max(df$cost2), length.out = 100),
replicate = unique(df$replicate),
target_closed_fraction=unique(df$target_closed_fraction)
)
# Get predictions for spaghetti plot
spaghetti_pred <- fitted(m, newdata = pred_data, re_formula = NULL,
summary = FALSE, allow_new_levels=TRUE)  # Keep all posterior samples
# Get predictions for spaghetti plot
spaghetti_pred <- fitted(m, newdata = pred_data, re_formula = NULL,
summary = FALSE)  # Keep all posterior samples
# Convert to dataframe for plotting
spaghetti_df <- as.data.frame(t(spaghetti_pred))
spaghetti_df$cost2 <- pred_data$cost2
spaghetti_df$replicate <- pred_data$replicate
# Create spaghetti plot
spaghetti_plot <- ggplot(spaghetti_df, aes(x = cost2, y = V1, group = target_closed_fraction)) +
geom_line(alpha = 0.3, linewidth = 0.5, color = "steelblue") +
labs(x = "cost2", y = "total_cost/total_length")+
theme_minimal()
print(spaghetti_plot)
# Convert to dataframe for plotting
d <- as.data.frame(t(spaghetti_pred))
d$cost2 <- d$cost2
d$replicate <- d$replicate
df$target_closed_fraction
unique(df$target_closed_fraction)
# Create prediction data for plotting
pred_data <- expand.grid(
cost2 = seq(min(df$cost2), max(df$cost2), length.out = 100),
replicate = unique(df$replicate),
target_closed_fraction=seq(min(df$target_closed_fraction), max(df$target_closed_fraction), length.out = 20)
)
pred_dataa
# Create prediction data for plotting
pred_data <- expand.grid(
cost2 = seq(min(df$cost2), max(df$cost2), length.out = 100),
replicate = unique(df$replicate),
target_closed_fraction=seq(min(df$target_closed_fraction), max(df$target_closed_fraction), length.out = 20)
)
pred_data
# Get predictions for spaghetti plot
spaghetti_pred <- fitted(m, newdata = pred_data, re_formula = NULL,
summary = FALSE)  # Keep all posterior samples
# Convert to dataframe for plotting
d <- as.data.frame(t(spaghetti_pred))
d$cost2 <- d$cost2
d$replicate <- d$replicate
d
d
library(ggplot2)
library(brms)
library(bayesplot)
library(tidybayes)
library(dplyr)
library(here)
setwd(file.path(here::here(),"Model_effect_size/model"))
m <- readRDS("gamma_m_nov.RDS")
setwd(file.path(here::here(),"Model_effect_size/data"))
df <- read.csv("2025_11_18_11targ0.6_cl_size5_r_size5targ0.7_cl_size5_r_size5targ0.8_cl_size5_r_size5targ0.9_cl_size5_r_size5.csv")
df <- df[df$total_length > 0, ]
df$rat <- df$total_cost / df$total_length
pred_data <- expand.grid(
cost2 = seq(min(df$cost2), max(df$cost2), length.out = 100),
target_closed_fraction = seq(min(df$target_closed_fraction),
max(df$target_closed_fraction), length.out = 20),
replicate = unique(df$replicate)
)
df$target_closed_fraction
df <- df[which(df$total_cost>0),]
df$rat <- df$total_cost / df$total_length
pred_data <- expand.grid(
cost2 = seq(min(df$cost2), max(df$cost2), length.out = 100),
target_closed_fraction = seq(min(df$target_closed_fraction),
max(df$target_closed_fraction), length.out = 20),
replicate = unique(df$replicate)
)
pred_data
library(tidyr)
spaghetti_df <- spaghetti_df %>%
pivot_longer(
cols = starts_with("V"),
names_to = "draw",
values_to = "estimate"
)
spaghetti_df <- spaghetti_df %>%
pivot_longer(
cols = starts_with("V"),
names_to = "draw",
values_to = "estimate"
)
pred_data <- expand.grid(
cost2 = seq(min(df$cost2), max(df$cost2), length.out = 100),
target_closed_fraction = seq(min(df$target_closed_fraction),
max(df$target_closed_fraction), length.out = 20),
replicate = unique(df$replicate)
)
library(tidyr)
spaghetti_pred <- fitted(
m,
newdata = pred_data,
re_formula = NULL,
summary = FALSE
)
# Convert to long format: each row = one posterior draw for one row of pred_data
spaghetti_df <- cbind(pred_data, as.data.frame(t(spaghetti_pred)))
spaghetti_df <- spaghetti_df %>%
pivot_longer(
cols = starts_with("V"),
names_to = "draw",
values_to = "estimate"
)
spaghetti_pred <- fitted(
m,
newdata = pred_data,
re_formula = NULL,
summary = FALSE
)
# Convert to long format: each row = one posterior draw for one row of pred_data
spaghetti_df <- cbind(pred_data, as.data.frame(t(spaghetti_pred)))
library(tidyr)
spaghetti_df <- spaghetti_df %>%
pivot_longer(
cols = starts_with("V"),
names_to = "draw",
values_to = "estimate"
)
spaghetti_plot <- ggplot(spaghetti_df,
aes(x = cost2, y = estimate,
group = interaction(target_closed_fraction, draw))) +
geom_line(alpha = 0.1, linewidth = 0.3, color = "steelblue") +
labs(x = "cost2",
y = "total_cost / total_length",
title = "Posterior Least-Cost Predictions Across Closed Substrate Levels") +
theme_minimal()
p <- ggplot(spaghetti_df,
aes(x = cost2, y = estimate,
group = interaction(target_closed_fraction, draw))) +
geom_line(alpha = 0.1, linewidth = 0.3, color = "steelblue") +
labs(x = "cost2",
y = "total_cost / total_length",
title = "Posterior Least-Cost Predictions Across Closed Substrate Levels") +
theme_minimal()
p
runif(1000, 0,1000)
seq(1,length(spaghetti_df$cost2),by=1)
length(spaghetti_df$cost2)
i<-sample(seq(1,length(spaghetti_df$cost2),by=1),size=100, replace=FALSE)
d<-sample(spaghetti_df[i,], )
p <- ggplot(daes(x = cost2, y = estimate,
group = interaction(target_closed_fraction, draw))) +
geom_line(alpha = 0.1, linewidth = 0.3, color = "steelblue") +
labs(x = "cost2",
y = "total_cost / total_length",
title = "Posterior Least-Cost Predictions Across Closed Substrate Levels") +
theme_minimal()
p <- ggplot(d, aes(x = cost2, y = estimate,
group = interaction(target_closed_fraction, draw))) +
geom_line(alpha = 0.1, linewidth = 0.3, color = "steelblue") +
labs(x = "cost2",
y = "total_cost / total_length",
title = "Posterior Least-Cost Predictions Across Closed Substrate Levels") +
theme_minimal()
p
i<-sample(seq(1,length(spaghetti_df$cost2),by=1),size=1000, replace=FALSE)
d<-sample(spaghetti_df[i,], )
p <- ggplot(d, aes(x = cost2, y = estimate,
group = interaction(target_closed_fraction, draw))) +
geom_line(alpha = 0.1, linewidth = 0.3, color = "steelblue") +
labs(x = "cost2",
y = "total_cost / total_length",
title = "Posterior Least-Cost Predictions Across Closed Substrate Levels") +
theme_minimal()
p
p <- ggplot(d, aes(x = cost2, y = estimate,
group = interaction(target_closed_fraction, draw))) +
geom_line(alpha = 0.6, linewidth = 0.3, color = "steelblue") +
labs(x = "cost2",
y = "total_cost / total_length",
title = "Posterior Least-Cost Predictions Across Closed Substrate Levels") +
theme_minimal()
p
i<-sample(seq(1,length(spaghetti_df$cost2),by=1),size=10000, replace=FALSE)
d<-sample(spaghetti_df[i,], )
p <- ggplot(d, aes(x = cost2, y = estimate,
group = interaction(target_closed_fraction, draw))) +
geom_line(alpha = 0.6, linewidth = 0.3, color = "steelblue") +
labs(x = "cost2",
y = "total_cost / total_length",
title = "Posterior Least-Cost Predictions Across Closed Substrate Levels") +
theme_minimal()
p
p <- ggplot(d, aes(x = cost2, y = estimate,
group = interaction(target_closed_fraction, draw))) +
geom_line(alpha = 0.4, linewidth = 0.3, color = "steelblue") +
labs(x = "cost2",
y = "total_cost / total_length",
title = "Posterior Least-Cost Predictions Across Closed Substrate Levels") +
theme_minimal()
p
p
pop_data <- data.frame(
cost2 = seq(min(df$cost2), max(df$cost2), length.out = 100),
target_closed_fraction = mean(df$target_closed_fraction)
)
df
pop_df <- data.frame(
cost2 = pop_data$cost2,
estimate = pop_pred[, "Estimate"],
lower = pop_pred[, "Q10"],
upper = pop_pred[, "Q90"]
)
pop_pred <- fitted(
m, newdata = pop_data, re_formula = NA,
probs = c(0.1, 0.9)
)
pop_df <- data.frame(
cost2 = pop_data$cost2,
estimate = pop_pred[, "Estimate"],
lower = pop_pred[, "Q10"],
upper = pop_pred[, "Q90"]
)
p <- ggplot() +
geom_point(data = df, aes(x = cost2, y = rat),
alpha = 0.3, size = 1, color = "gray50") +
geom_ribbon(data = pop_df, aes(x = cost2, ymin = lower, ymax = upper),
alpha = 0.3, fill = "steelblue") +
geom_line(data = pop_df, aes(x = cost2, y = estimate),
linewidth = 1.5, color = "darkblue") +
theme_minimal() +
labs(x = "cost2", y = "rat (total_cost / total_length)",
title = "Population-Level Effect of cost2\n(at mean closed coverage)")
p
pred_data <- data.frame(
cost2 = seq(min(df$cost2), max(df$cost2), length.out = 100),
target_closed_fraction = mean(df$target_closed_fraction)
)
pop_pred <- fitted(
m, newdata = pred_data, re_formula = NA,
probs = c(0.10, 0.90)
)
pred_interval <- predict(
m, newdata = pred_data, re_formula = NA,
probs = c(0.10, 0.90)
)
plot_df <- data.frame(
cost2 = pred_data$cost2,
estimate = pop_pred[, "Estimate"],
lower_mean = pop_pred[, "Q10"],
upper_mean = pop_pred[, "Q90"],
lower_pred = pred_interval[, "Q10"],
upper_pred = pred_interval[, "Q90"]
)
prediction_plot <- ggplot() +
geom_point(data = df, aes(x = cost2, y = rat),
alpha = 0.8, size = 1, color = "gray50") +
geom_ribbon(data = plot_df, aes(x = cost2, ymin = lower_pred, ymax = upper_pred),
alpha = 0.2, fill = "red") +
geom_ribbon(data = plot_df, aes(x = cost2, ymin = lower_mean, ymax = upper_mean),
alpha = 0.4, fill = "steelblue") +
geom_line(data = plot_df, aes(x = cost2, y = estimate),
linewidth = 1.5, color = "darkblue") +
theme_bw() +
labs(x = "cost2", y = "rat",
title = "80% HDI & Prediction Intervals\n(at mean closed coverage)")
p <- ggplot() +
geom_point(data = df, aes(x = cost2, y = rat),
alpha = 0.8, size = 1, color = "gray50") +
geom_ribbon(data = plot_df, aes(x = cost2, ymin = lower_pred, ymax = upper_pred),
alpha = 0.2, fill = "red") +
geom_ribbon(data = plot_df, aes(x = cost2, ymin = lower_mean, ymax = upper_mean),
alpha = 0.4, fill = "steelblue") +
geom_line(data = plot_df, aes(x = cost2, y = estimate),
linewidth = 1.5, color = "darkblue") +
theme_bw() +
labs(x = "cost2", y = "rat",
title = "80% HDI & Prediction Intervals\n(at mean closed coverage)")
p
p <- m %>%
as_draws_df() %>%
ggplot(aes(x = b_cost2)) +
geom_density(fill = "steelblue", alpha = 0.7) +
geom_vline(xintercept = 0, color = "red", linetype = "dashed") +
theme_minimal() +
labs(x = "cost2 coefficient",
y = "Density",
title = "Posterior Distribution of cost2 Effect")
p
library(tidybayes)
library(dplyr)
library(ggplot2)
### Plot the
# Choose closed fractions to visualize
closed_vals <- c(0.6, 0.7, 0.8, 0.9)
# Extract posterior draws
draws <- m %>% as_draws_df()
# Compute marginal effect of cost2 at each closed fraction
marginal_df <- lapply(closed_vals, function(cf) {
tibble(
target_closed_fraction = cf,
marginal_effect = draws$b_cost2 + draws$`b_cost2:target_closed_fraction` * cf
)
}) %>% bind_rows()
# Faceted density plot
p <- ggplot(marginal_df, aes(x = marginal_effect)) +
geom_density(fill = "steelblue", alpha = 0.7) +
geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
facet_wrap(~ target_closed_fraction, ncol = 2) +
theme_minimal() +
labs(
x = "Marginal effect of cost2",
y = "Density",
title = "Posterior Distribution of the Effect of cost2\nAcross Closed Substrate Fractions"
)
p
# Faceted density plot
p <- ggplot(marginal_df, aes(x = marginal_effect, fill=target_closed_fraction)) +
geom_density(alpha = 0.7) +
geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
facet_wrap(~ target_closed_fraction, ncol = 2) +
theme_minimal() +
labs(
x = "Marginal effect of cost2",
y = "Density",
title = "Posterior Distribution of the Effect of cost2\nAcross Closed Substrate Fractions"
)
p
# Faceted density plot
p <- ggplot(marginal_df, aes(x = marginal_effect, fill=target_closed_fraction)) +
geom_density(alpha = 0.7) +
geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
theme_minimal() +
labs(
x = "Marginal effect of cost2",
y = "Density",
title = "Posterior Distribution of the Effect of cost2\nAcross Closed Substrate Fractions"
)
p
# Faceted density plot
p <- ggplot(marginal_df, aes(x = marginal_effect, group=target_closed_fraction, fill=target_closed_fraction)) +
geom_density(alpha = 0.7) +
geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
theme_minimal() +
labs(
x = "Marginal effect of cost2",
y = "Density",
title = "Posterior Distribution of the Effect of cost2\nAcross Closed Substrate Fractions"
)
p
draws <- m %>% as_draws_df()
closed_vals <- c(0.7, 0.8, 0.9)
clusters <- c("Cluster 1", "Cluster 2", "Cluster 3")
marginals <- expand.grid(
cluster = clusters,
target_closed_fraction = closed_vals
) %>%
as_tibble() %>%
mutate(
marginal_effect = map(target_closed_fraction, ~
draws$b_cost2 + draws$`b_cost2:target_closed_fraction` * .x
)
) %>%
unnest(marginal_effect)
### Now, trying to stack posterior densities:
library(tidyverse)
library(tidybayes)
library(ggplot2)
draws <- m %>% as_draws_df()
closed_vals <- c(0.7, 0.8, 0.9)
clusters <- c("Cluster 1", "Cluster 2", "Cluster 3")
marginals <- expand.grid(
cluster = clusters,
target_closed_fraction = closed_vals
) %>%
as_tibble() %>%
mutate(
marginal_effect = map(target_closed_fraction, ~
draws$b_cost2 + draws$`b_cost2:target_closed_fraction` * .x
)
) %>%
unnest(marginal_effect)
p <- ggplot(marginals, aes(
x = marginal_effect,
color = factor(target_closed_fraction),
fill = factor(target_closed_fraction)
)) +
geom_density(alpha = 0.3, linewidth = 1) +
facet_wrap(~ cluster, ncol = 1, scales = "free_y") +
geom_vline(xintercept = 0, linetype = "dashed") +
scale_color_brewer(palette = "Dark2", name = "Closed fraction") +
scale_fill_brewer(palette = "Dark2", name = "Closed fraction") +
theme_minimal(base_size = 14) +
labs(
x = "Marginal effect of cost2 on rat",
y = "Density",
title = "Effect of Cost on RAT (total_cost / total_length)\nAcross Clusters and Substrate Conditions"
)
p
costs<-c(1, 1.5, 3.25, 5)
# Create prediction dataset
pred_grid <- expand_grid(
target_closed_fraction = closed_vals,
cost2 = costs
)
draws_pred <- m %>%
add_fitted_draws(
newdata = pred_grid,
re_formula = NA,
dpar = FALSE
)
draws_pred <- m %>%
epred_draws(
newdata = pred_grid,
re_formula = NA,
dpar = FALSE
)
library(tidyverse)
library(tidybayes)
library(ggridges)
closed_vals <- c(0.7, 0.8, 0.9)
costs <- c(1, 1.5, 3.25, 5)   # include 1 explicitly as baseline
# Create prediction dataset
pred_grid <- expand_grid(
target_closed_fraction = closed_vals,
cost2 = costs
)
# Draw from posterior predictive expected values
draws_pred <- m %>%
epred_draws(
newdata = pred_grid,
re_formula = NA
)
# Compute effect sizes relative to cost = 1 *within each draw and closed level*
effects <- draws_pred %>%
group_by(.draw, target_closed_fraction) %>%
mutate(
baseline = .epred[cost2 == 1],
effect_size = .epred / baseline
) %>%
ungroup()
# Make cost a nicer factor for ordering in ridge plot
effects <- effects %>%
mutate(
cost_label = factor(cost2, levels = costs)
)
# Ridge plot: densities of effect sizes, stacked by closed
ggplot(effects, aes(x = effect_size, y = cost_label, fill = cost_label)) +
geom_density_ridges(alpha = 0.8, color = "white") +
facet_wrap(~ target_closed_fraction, ncol = 1, scales = "free_y") +
labs(
x = "Effect size (relative to cost = 1)",
y = "Cost",
title = "Posterior Effect Sizes by Closed Level",
subtitle = "Effect = RAT(closed, cost) / RAT(closed, 1)"
) +
theme_minimal(base_size = 14) +
theme(legend.position = "none")
library(here)
library(brms)
library(cmdstanr)
library(ggplot2)
setwd(paste(here::here(),"/Model_effect_size/data", sep="",collapse=""))
df<-read.csv("2025_11_18_11targ0.6_cl_size5_r_size5targ0.7_cl_size5_r_size5targ0.8_cl_size5_r_size5targ0.9_cl_size5_r_size5.csv")
head(df)
df
df$rat<-df$cost2/df$total_length
ggplot(df, aes(x=rat,y=cost2,fill=cost2))+geom_density_ridges()+
facet_wrap(~target_closed_fraction)
ggplot(df, aes(x=rat,y=as.factor(cost2),fill=as.factor(cost2)))+geom_density_ridges()+
facet_wrap(~target_closed_fraction)
ggplot(df, aes(x=rat,y=target_closed_fraction,fill=target_closed_fraction))+geom_density_ridges()+
facet_wrap(~cost2)
ggplot(df, aes(x=rat,y=as.factor(target_closed_fraction),fill=as.factor(target_closed_fraction)))+geom_density_ridges()+
facet_wrap(~cost2)
ggplot(df, aes(x=sinuosity,y=as.factor(target_closed_fraction),fill=as.factor(target_closed_fraction)))+geom_density_ridges()+
facet_wrap(~cost2)
